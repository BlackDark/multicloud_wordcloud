<!DOCTYPE html>
<html>
<head lang="en">
	<meta charset="UTF-8">
	<title></title>
	<style>

		.link {
			stroke: #000;
			stroke-width: 1.5px;
		}

		.node {
			cursor: move;
			fill: #ccc;
			stroke: #000;
			stroke-width: 1.5px;
		}

		.node.fixed {
			fill: #f00;
		}

		.noselect {
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		rect.overlap {
			fill: red;
		}

		text {
		}

		#width-test {
			position: absolute;
			float: left;
			white-space: nowrap;
			visibility: hidden;
		}

	</style>
</head>
<body>
<script src="d3/d3.js"></script>
<script>(function () {

	var numberOfWords = 200;
	var drawLinks = false;
	var showOriginalPos = true;
	var reduceLinkStrength = true;
	var variableCharge = false;


	var fill = d3.scale.category20();

	var width = 960,
			height = 500;

	function testStrength(link, index) {
		if (link.strength) {
			if(reduceLinkStrength) {
				return link.strength - 0.05 < 0 ? 0 : link.strength - 0.05;
			} else {
				return link.strength;
			}
		}

		return 0.1;
	}

	var force = d3.layout.force()
			.size([width, height])
			// Gravity removed for positioning only with links
			//.gravity(0)
			.charge(variableCharge ? chargeTest : -50)
			.linkDistance(20)
			.linkStrength(testStrength)
			.on("tick", tick);

	function chargeTest(theNode) {
		if(theNode.width) {
			return theNode.width * (-4);
		}

		return 0;
	}

	var drag = force.drag()
			.on("dragstart", dragstart);

	var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);

	var link = svg.selectAll(".link"),
			node = svg.selectAll(".node");

	var originalPosLink;

	var nodes = getObjects(4);

	var links = createLinks(nodes, 4);

	force.nodes(nodes)
				.links(links)
				.on("end", onEnd)
				.start();

	if (drawLinks) {
		link = link.data(links)
				.enter().append("line")
				.attr("class", "link");
	}

		node = node.data(nodes)
				.enter().append("g");

	node.append("title")
			.text(function(d) {
				return "End1: " + d.end1
						+ " End2: " + d.end2
						+ " End3: " + d.end3
						+ " End4: " + d.end4
			});

	node.each(function(current) {
		current.rectContainer = d3.select(this).append("circle")
				.attr("r", function(d) {return d.radius;})
				.classed("node", true)
				.classed("circle", true);
	});

	function tick() {
		if (drawLinks) {
			link.attr("x1", function (d) {
				return d.source.x;
			})
					.attr("y1", function (d) {
						return d.source.y;
					})
					.attr("x2", function (d) {
						return d.target.x;
					})
					.attr("y2", function (d) {
						return d.target.y;
					});
		}

		var q = d3.geom.quadtree(nodes),
				i = 3,
				n = nodes.length;

		while (++i < n) {
			q.visit(collide(nodes[i]));
		}

		node.attr("transform", function(d) {
			return "translate(" + [d.x, d.y] + ")";
		});
	}

	function hasOverlap(node, nodes) {
		var overlap = false;

		nodes.forEach(function(checkNode){
			if (checkNode && (checkNode !== node)) {

				var x = node.x - checkNode.x,
						y = node.y - checkNode.y,
						xSpacing = (checkNode.width + node.width) / 2,
						ySpacing = (checkNode.height + node.height) / 2,
						absX = Math.abs(x),
						absY = Math.abs(y);

				if (absX < xSpacing && absY < ySpacing) {
					overlap = true;
				}
			}
		});

		return overlap;
	}

	function collide(node) {
		var r = node.radius + 16,
				nx1 = node.x - r,
				nx2 = node.x + r,
				ny1 = node.y - r,
				ny2 = node.y + r;
		return function(quad, x1, y1, x2, y2) {
			if (quad.point && (quad.point !== node)) {
				var x = node.x - quad.point.x,
						y = node.y - quad.point.y,
						l = Math.sqrt(x * x + y * y),
						r = node.radius + quad.point.radius;
				if (l < r) {
					l = (l - r) / l * .5;
					node.x -= x *= l;
					node.y -= y *= l;
					quad.point.x += x;
					quad.point.y += y;
				}
			}
			return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
		};
	}

	function onEnd(){
		drawOriginalPositionLink();
		//markOverlapping();
	}

	function markOverlapping() {
		for (var i = 4; i < nodes.length; i++) {
			if(hasOverlap(nodes[i], nodes)) {
				console.log(nodes[i]);
				nodes[i].rectContainer.classed("overlap", true);
			}
		}
	}

	function drawOriginalPositionLink() {
		if(!showOriginalPos) {
			  return;
		}

		originalPosLink = svg.append("g");

		for(var i = 4; i < nodes.length; i++) {
			var positionX = nodes[0].x * nodes[i].end1 +
					nodes[1].x * nodes[i].end2 +
					nodes[2].x * nodes[i].end3 +
					nodes[3].x * nodes[i].end4;

			var positionY = nodes[0].y * nodes[i].end1 +
					nodes[1].y * nodes[i].end2 +
					nodes[2].y * nodes[i].end3 +
					nodes[3].y * nodes[i].end4;

			originalPosLink.append("line")
					.attr("class", "link")
					.attr("x1", function (d) {
						return nodes[i].x;
					})
					.attr("y1", function (d) {
						return nodes[i].y;
					})
					.attr("x2", function (d) {
						return positionX;
					})
					.attr("y2", function (d) {
						return positionY;
					});
		}
	}

	function dblclick(d) {
		d3.select(this).classed("fixed", d.fixed = false);
	}

	function dragstart(d) {
		return;
		d3.select(this).classed("fixed", d.fixed = true);
	}


	function getObjects(numberOfDocuments) {
		var text = "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum. What the cynics fail to understand is that the ground has shifted beneath them - that the stale political arguments that have consumed us for so long no longer apply. The question we ask today is not whether our government is too big or too small, but whether it works - whether it helps families find jobs at a decent wage, care they can afford, a retirement that is dignified. Where the answer is yes, we intend to move forward. Where the answer is no, programs will end. And those of us who manage the public's dollars will be held to account - to spend wisely, reform bad habits, and do our business in the light of day - because only then can we restore the vital trust between a people and their government.	Nor is the question before us whether the market is a force for good or ill. Its power to generate wealth and expand freedom is unmatched, but this crisis has reminded us that without a watchful eye, the market can spin out of control - and that a nation cannot prosper long when it favors only the prosperous. The success of our economy has always depended not just on the size of our Gross Domestic Product, but on the reach of our prosperity; on the ability to extend opportunity to every willing heart - not out of charity, but because it is the surest route to our common good.";

		var tokenArray = text.split(" ");

		if(tokenArray.length > numberOfWords) {
			tokenArray = tokenArray.slice(0, numberOfWords);
		}

		console.log(tokenArray.length + " words.");

		var te = [];

		te = te.concat(getEndpoints(4));
		te = te.concat(getTextObjects(tokenArray, 4));

		return te;
	}

	function getEndpoints(numDocs) {
		return [
			{
				text: "End1",
				x: 5,
				y: 5,
				fixed: true,
				id: 0
			},
			{
				text: "End2",
				x: width - 5,
				y: 5,
				fixed: true,
				id: 1
			},
			{
				text: "End3",
				x: 5,
				y: height - 5,
				fixed: true,
				id: 2
			},
			{
				text: "End4",
				x: width - 5,
				y: height - 5,
				fixed: true,
				id: 3
			}
		];
	}

	function getTextObjects(tokenArray, numDocs){
		var objects = [];
		var index = 4;



		tokenArray.forEach(function(entry) {
			var distr = getRandomDistribution(4);
			//var height = Math.floor(Math.random() * 15 + 12);
			var height = 12;

			var newObject = {
				text: entry,
				size: height,
				width: widthText(entry),
				height: height,
				end1: distr[0],
				end2: distr[1],
				end3: distr[2],
				end4: distr[3],
				id: +index
			};

			newObject.radius = newObject.width / 2 + 1;

			objects.push(newObject);

			index++;
		});

		return objects;
	}

	function getRandomDistribution(numNumbers) {
		var randomNumers = [];

		for(var i = 0; i < numNumbers - 1; i++) {
			randomNumers.push(Math.random());
		}

		randomNumers.sort(function(a, b){return a-b});

		var recalc = [];

		for(var j = 0; j < numNumbers; j++) {
			if (j === 0) {
				recalc.push(randomNumers[j] - 0);
				continue;
			}

			if (j === numNumbers - 1) {
				recalc.push(1 - randomNumers[j - 1]);
				continue;
			}

			recalc.push(randomNumers[j] - randomNumers[j - 1]);

		}
		return shuffle(recalc);
	}

	function shuffle(o){
		for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
		return o;
	}

	function createLinks(nodes, number) {
		var newLinks = [];

		for(var i = number; i < nodes.length; i++) {
			var currentNode = nodes[i];

			newLinks.push({
				source: currentNode.id,
				target: 0,
				strength: currentNode.end1
			});

			newLinks.push({
				source: currentNode.id,
				target: 1,
				strength: currentNode.end2
			});

			newLinks.push({
				source: currentNode.id,
				target: 2,
				strength: currentNode.end3
			});

			newLinks.push({
				source: currentNode.id,
				target: 3,
				strength: currentNode.end4
			});
		}

		return newLinks;
	}

	function widthText(text, textStyle) {
		// Set a default value
		if (!textStyle) {
			textStyle = "text";
		}

		var d = d3.select("body")
						.append("div")
						.attr("class", textStyle)
						.attr("id", "width-test") // tag this element to identify it
						.text(text),
				w = document.getElementById("width-test").offsetWidth;
		d.remove();
		console.log(w);
		return w;
	}

})();</script>
