<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <style>

    .link {
      stroke: #000;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>
<script src="d3/d3.js"></script>
<script src="../d3.layout.cloud.js"></script>
<script>(function() {

var fill = d3.scale.category20();
  var endPoints = [
    {
      test: "bla",
      x: 1,
      y: 1
    },
    {
      test: "bla",
      x: 500,
      y: 1
    },
    {
      test: "bla",
      x: 1,
      y: 500
    },
    {
      test: "bla",
      x: 500,
      y: 500
    }
  ];

  var objects = [
    {
      text: "Test1",
      size: 12,
      startX: 1,
      startY: 1
    },
    {
      text: "Test2",
      size: 12,
      startX: 500,
      startY: 1
    },
    {
      text: "Test3",
      size: 12,
      startX: 1,
      startY: 500
    },
    {
      text: "Test4",
      size: 12,
      startX: 500,
      startY: 500
    },
    {
      text: "Test5",
      size: 12,
      startX: 2,
      startY: 2
    },
    {
      text: "Test6",
      size: 12,
      startX: 3,
      startY: 3
    },
    {
      text: "Test7",
      size: 12,
      startX: 410,
      startY: 410
    },
    {
      text: "Test8",
      size: 12,
      startX: 490,
      startY: 1
    },
    {
      text: "Test9",
      size: 12,
      startX: 480,
      startY: 1
    },
    {
      text: "Test10",
      size: 12,
      startX: 1,
      startY: 490
    }
  ];

  var showOrigPos = true
  var originalPosLink;

  var force = d3.layout.force();

  var tokens = getObjects(4);
  console.log(tokens);

var layout = d3.layout.cloud()
    .size([500, 500])
    .words(tokens)
    .padding(5)
    .rotate(function() { return 0; })
    .font("Impact")
    .fontSize(function(d) { return d.size; })
    //.spiral(test)
    .on("end", draw);

  layout.start();

// size is the [width, height] array specified in cloud.size
  function test(size) {
    // t indicates the current step along the spiral; it may monotonically
    // increase or decrease indicating clockwise or counterclockwise motion.
    return function(t) {
      //console.log(t);
      return [t, t];
    };
  }

function draw(words) {
  var textElements = d3.select("body").append("svg")
      .attr("width", layout.size()[0])
      .attr("height", layout.size()[1])
    .append("g")
      .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
    .selectAll("text")
      .data(words)
    .enter().append("text");


      textElements.style("font-size", function(d) { return d.size + "px"; })
      .style("font-family", "Impact")
      .style("fill", function(d, i) { return fill(i); })
      .style("font-size", function(d) { return d.size + "px"; })
      .attr("text-anchor", "middle")
      .attr("transform", function(d) {
       //console.log("Tag: " + d.text + " | Start: " + [d.startX, d.startY] + " | Current: " + [d.x + layout.size()[0] / 2, d.y + layout.size()[1] / 2]);
        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
      })
      .text(function(d) { return d.text; })

  textElements.append("title")
      .text(function(d) {
        return "X: " + d.startX +
                ", Y: " + d.startY;
      });

  originalPosLink = d3.select("body").select("svg").append("g");

  textElements.each(function(d) {
    drawOriginalPositionLink([d.startX, d.startY], [d.x + layout.size()[0] / 2, d.y + layout.size()[1] / 2]);
  })
}

  function drawOriginalPositionLink(startXY, currentXY) {
    console.log(startXY + " " + currentXY);

    if(!showOrigPos) {
      return;
    }

      originalPosLink.append("line")
          .attr("class", "link")
          .attr("x1", function (d) {
            return startXY[0];
          })
          .attr("y1", function (d) {
            return startXY[1];
          })
          .attr("x2", function (d) {
            return currentXY[0];
          })
          .attr("y2", function (d) {
            return currentXY[1];
          });
  }


  function getObjects(numberOfDocuments) {
    var text = "What the cynics fail to understand is that the ground has shifted beneath them - that the stale political arguments that have consumed us for so long no longer apply. The question we ask today is not whether our government is too big or too small, but whether it works - whether it helps families find jobs at a decent wage, care they can afford, a retirement that is dignified. Where the answer is yes, we intend to move forward. Where the answer is no, programs will end. And those of us who manage the public's dollars will be held to account - to spend wisely, reform bad habits, and do our business in the light of day - because only then can we restore the vital trust between a people and their government.	Nor is the question before us whether the market is a force for good or ill. Its power to generate wealth and expand freedom is unmatched, but this crisis has reminded us that without a watchful eye, the market can spin out of control - and that a nation cannot prosper long when it favors only the prosperous. The success of our economy has always depended not just on the size of our Gross Domestic Product, but on the reach of our prosperity; on the ability to extend opportunity to every willing heart - not out of charity, but because it is the surest route to our common good.";

    //var text = "Test1 Test2 Test3 Test4 Test5 Test6 Test7 Test8 Test9";
    var tokenArray = text.split(" ");

    var te = [];
    te = te.concat(getTextObjects(tokenArray, 4));

    return te;
  }

  function getTextObjects(tokenArray, numDocs){
    var objects = [];

    tokenArray.forEach(function(entry) {
      var distr = getRandomDistribution(4);

      var positionX = endPoints[0].x * distr[0] +
          endPoints[1].x * distr[1] +
          endPoints[2].x * distr[2] +
          endPoints[3].x * distr[3];

      var positionY = endPoints[0].y * distr[0] +
          endPoints[1].y * distr[1] +
          endPoints[2].y * distr[2] +
          endPoints[3].y * distr[3];

      objects.push({
        text: entry,
        size: 12,
        end1: distr[0],
        end2: distr[1],
        end3: distr[2],
        end4: distr[3],
        startX: positionX,
        startY: positionY
      });
    });

    return objects;
  }

  function getRandomDistribution(numNumbers) {
    var randomNumers = [];

    for(var i = 0; i < numNumbers - 1; i++) {
      randomNumers.push(Math.random());
    }

    randomNumers.sort(function(a, b){return a-b});

    var recalc = [];

    for(var j = 0; j < numNumbers; j++) {
      if (j === 0) {
        recalc.push(randomNumers[j] - 0);
        continue;
      }

      if (j === numNumbers - 1) {
        recalc.push(1 - randomNumers[j - 1]);
        continue;
      }

      recalc.push(randomNumers[j] - randomNumers[j - 1]);

    }
    return shuffle(recalc);
  }

  function shuffle(o){
    for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
    return o;
  }

})();</script>
