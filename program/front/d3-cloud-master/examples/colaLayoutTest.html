<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Non-overlapping Layout</title>
	<style>

		.node {
			stroke: #fff;
			stroke-width: 1.5px;
			cursor: move;
		}

		.link {
			stroke: #999;
			stroke-width: 3px;
			stroke-opacity: 1;
		}

		.label {
			fill: white;
			font-family: Verdana;
			font-size: 25px;
			text-anchor: middle;
			cursor: move;
		}

		text {
		}

		#width-test {
			position: absolute;
			float: left;
			white-space: nowrap;
			visibility: hidden;
		}

	</style>
</head>
<body>
<h1>Disconnected graph with non-overlap constraints</h1>
<script src="d3/d3.js"></script>
<script src="cola/cola.v3.min.js"></script>
<script>
	var width = 960,
			height = 500;

	var endPoints = [
		{
			test: "bla",
			x: 1,
			y: 1
		},
		{
			test: "bla",
			x: 500,
			y: 1
		},
		{
			test: "bla",
			x: 1,
			y: 500
		},
		{
			test: "bla",
			x: 500,
			y: 500
		}
	];

	var color = d3.scale.category20();

	var cola = cola.d3adaptor()
			.linkDistance(120)
			.avoidOverlaps(true)
			.size([width, height]);

	var svg = d3.select("body").append("svg")
			.attr("width", width)
			.attr("height", height);

	var graph = {
		"nodes": undefined,
		"links": undefined
	};

	var nodes = getObjects(4);
	var links = createLinks(nodes, 4);

	graph.nodes = nodes;
	graph.links = links;


		cola
				.nodes(graph.nodes)
				.links(graph.links)
				.start();

		var link = svg.selectAll(".link")
				.data(graph.links)
				.enter().append("line")
				.attr("class", "link");

		var node = svg.selectAll(".node")
				.data(graph.nodes)
				.enter()
				.append("rect")
				.attr("class", "node")
				.attr("width", function (d) { return d.width; })
				.attr("height", function (d) { return d.height; })
				.attr("rx", 5).attr("ry", 5)
				.style("fill", function (d) { return color(1); })
				.call(cola.drag);

		var label = svg.selectAll(".label")
				.data(graph.nodes)
				.enter().append("text")
				.attr("class", "label")
				.text(function (d) { return d.name; })
				.call(cola.drag);

		node.append("title")
				.text(function (d) { return d.name; });

		cola.on("tick", function () {
			link.attr("x1", function (d) { return d.source.x; })
					.attr("y1", function (d) { return d.source.y; })
					.attr("x2", function (d) { return d.target.x; })
					.attr("y2", function (d) { return d.target.y; });

			node.attr("x", function (d) { return d.x - d.width / 2; })
					.attr("y", function (d) { return d.y - d.height / 2; });

			label.attr("x", function (d) { return d.x; })
					.attr("y", function (d) {
						var h = this.getBBox().height;
						return d.y + h/4;
					});
		});

	function getObjects(numberOfDocuments) {
		//var text = "Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum. Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took a galley of type and scrambled it to make a type specimen book. It has survived not only five centuries, but also the leap into electronic typesetting, remaining essentially unchanged. It was popularised in the 1960s with the release of Letraset sheets containing Lorem Ipsum passages, and more recently with desktop publishing software like Aldus PageMaker including versions of Lorem Ipsum. What the cynics fail to understand is that the ground has shifted beneath them - that the stale political arguments that have consumed us for so long no longer apply. The question we ask today is not whether our government is too big or too small, but whether it works - whether it helps families find jobs at a decent wage, care they can afford, a retirement that is dignified. Where the answer is yes, we intend to move forward. Where the answer is no, programs will end. And those of us who manage the public's dollars will be held to account - to spend wisely, reform bad habits, and do our business in the light of day - because only then can we restore the vital trust between a people and their government.	Nor is the question before us whether the market is a force for good or ill. Its power to generate wealth and expand freedom is unmatched, but this crisis has reminded us that without a watchful eye, the market can spin out of control - and that a nation cannot prosper long when it favors only the prosperous. The success of our economy has always depended not just on the size of our Gross Domestic Product, but on the reach of our prosperity; on the ability to extend opportunity to every willing heart - not out of charity, but because it is the surest route to our common good.";

		var text = "200 Wörter Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the  text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy tex text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy tex industry's standard dummy text ever since the 1500s, when an unknown printer took Lorem Ipsum is simply dummy text of the printing and typesetting industry. Lorem Ipsum has been the industry's standard dummy text ever since the 1500s, when an unknown printer took";
		//var text = "Kleiner Test Text um die Wörter zu verschieben in gewünschte Richtung";
		//var text = "Overlap Test";
		var tokenArray = text.split(" ");

		console.log(tokenArray.length + " words.");

		var te = [];

		te = te.concat(getEndpoints(4));
		te = te.concat(getTextObjects(tokenArray, 4));

		return te;
	}

	function getEndpoints(numDocs) {
		return [
			{
				text: "End1",
				x: 5,
				y: 5,
				fixed: true,
				id: 0
			},
			{
				text: "End2",
				x: width - 5,
				y: 5,
				fixed: true,
				id: 1
			},
			{
				text: "End3",
				x: 5,
				y: height - 5,
				fixed: true,
				id: 2
			},
			{
				text: "End4",
				x: width - 5,
				y: height - 5,
				fixed: true,
				id: 3
			}
		];
	}

	function getTextObjects(tokenArray, numDocs){
		var objects = [];
		var index = 4;



		tokenArray.forEach(function(entry) {
			var distr = getRandomDistribution(4);
			var height = Math.floor(Math.random() * 30 + 12);
			//var height = 12;
			objects.push({
				text: entry,
				size: height,
				width: widthText(entry),
				height: height,
				end1: distr[0],
				end2: distr[1],
				end3: distr[2],
				end4: distr[3],
				id: +index
			});

			index++;
		});

		return objects;
	}

	function getRandomDistribution(numNumbers) {
		var randomNumers = [];

		for(var i = 0; i < numNumbers - 1; i++) {
			randomNumers.push(Math.random());
		}

		randomNumers.sort(function(a, b){return a-b});

		var recalc = [];

		for(var j = 0; j < numNumbers; j++) {
			if (j === 0) {
				recalc.push(randomNumers[j] - 0);
				continue;
			}

			if (j === numNumbers - 1) {
				recalc.push(1 - randomNumers[j - 1]);
				continue;
			}

			recalc.push(randomNumers[j] - randomNumers[j - 1]);

		}
		return shuffle(recalc);
	}

	function shuffle(o){
		for(var j, x, i = o.length; i; j = Math.floor(Math.random() * i), x = o[--i], o[i] = o[j], o[j] = x);
		return o;
	}

	function createLinks(nodes, number) {
		var newLinks = [];

		for(var i = number; i < nodes.length; i++) {
			var currentNode = nodes[i];

			newLinks.push({
				source: currentNode.id,
				target: 0,
				strength: currentNode.end1
			});

			newLinks.push({
				source: currentNode.id,
				target: 1,
				strength: currentNode.end2
			});

			newLinks.push({
				source: currentNode.id,
				target: 2,
				strength: currentNode.end3
			});

			newLinks.push({
				source: currentNode.id,
				target: 3,
				strength: currentNode.end4
			});
		}

		return newLinks;
	}

	function widthText(text, textStyle) {
		// Set a default value
		if (!textStyle) {
			textStyle = "text";
		}

		var d = d3.select("body")
						.append("div")
						.attr("class", textStyle)
						.attr("id", "width-test") // tag this element to identify it
						.text(text),
				w = document.getElementById("width-test").offsetWidth;
		d.remove();
		return w;
	}

</script>
<p>Since node 'e' is not connected to the rest of the graph, it does not influence the layout of the connected component
	except through constraints.  In this case, we generate constraints to prevent node boxes from overlapping.  Try dragging 'e'
	so that it collides with the other nodes.
</p>
</body>
</html>
